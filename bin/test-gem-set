#! /usr/bin/env bash
#
#  script to test a set of gem files
#
set -o errexit
set -o nounset
set -o pipefail

gems=$*
gem_platform_local=`ruby -e "puts Gem::Platform.local.to_s"`

function remove_all {
  gem uninstall --all --force $1
}

function assert_sqlite_version_matches {
  ruby -r sqlite3 -e '\
    puts "compiled #{SQLite3::SQLITE_VERSION} / loaded #{SQLite3::SQLITE_LOADED_VERSION}"; \
    raise("sqlite version mismatch") unless SQLite3::SQLITE_VERSION == SQLite3::SQLITE_LOADED_VERSION; \
  '
}

function test_installation {
  gem=$1

  # test installation
  remove_all sqlite3
  gem install $gem
  assert_sqlite_version_matches

  if [[ $gem =~ sqlite3-[^-]*\.gem ]] ; then
    # test installation against system libs without mini_portile, linux distro repackagers
    # (note that we don't care about running the gem in this case, just building it)
    # see https://github.com/sparklemotion/sqlite3-ruby/pull/381 for background
    remove_all sqlite3
    remove_all mini_portile2
    gem install --local --force $gem -- --enable-system-libraries
    if gem list -i mini_portile2 ; then
      echo "FAIL: should not have installed mini_portile2"
      exit 1
    fi

    # test installation against system libs
    remove_all sqlite3
    gem install $gem -- --enable-system-libraries
    assert_sqlite_version_matches
  fi
}

for gem in $gems ; do
  ./bin/test-gem-file-contents $gem
done

for gem in $gems ; do
  if [[ $gem =~ sqlite3-[^-]+(-${gem_platform_local})?\.gem$ ]] ; then
    test_installation $gem
  fi
done
